---
title: "Genetic diversity analises"
---

## Objetivos

Previos:
    - Alelos nulos ?
    - HWE?
    - LD?


Descriptivos:
    - Número de muestras por sitio de muestreo
    - Número de alelos 
    - Alelos rarefacción 
    - Diversidad génica (hs) por población
    - Diversidad génica por especie

Estructura genética 
    - Fst?
    - AMOVA (entre especies, entre poblaciones dentro de las especies) - PHIst 

Estructura filogeográfica 
    - Gst vs Nst

Red de haplotipos 


## Datos

```{r}
library(adegenet)
library(googlesheets4)
library(tidyverse)
library(hierfstat)

# Cargar los datos en adegenet

df = read_sheet("https://docs.google.com/spreadsheets/d/1TuepHgDTVpBpM4PaWOm3fZCqwoQWpmTCRvU24AWT7B0/edit?usp=sharing", sheet = 1, col_type = "cccddiiiiiiii")


genind = df %>% 
        select(starts_with("locus")) %>% 
        df2genind(X = ., ploidy = 1, sep = "")

genind@pop = as.factor(str_remove(df$pop,"pop"))
genind@strata = df[,c(1,3)] %>% mutate(pop = str_remove(df$pop,"pop"))

genind@other = df[,c(1,2,4,5)]

gind_list = list(hy = genind[which(genind@strata$Species == "Quercus hypoleucoides")], 
                si =  genind[which(genind@strata$Species == "Quercus scytophylla")],
                sy = genind[which(genind@strata$Species == "Quercus sideroxyla")])
names(gind_list) = unique(df$Species)

```

### Mapa muestras 
```{r}
Mexico <- map_data(map = "world", region = "mexico")

ggplot()+
    geom_polygon(data = Mexico, aes(x = long, y = lat, group = group))+
    geom_point(data = genind@other, aes(x = lon, y = lat, color = Species))
    
```

## Descriptivos: Diversidad genética

```{r}
# summary adegenet
summary(genind)

# basic stats hierfstat (per locus and overall)

hfstat_all <- genind2hierfstat(genind)

basicstat <- basic.stats(hfstat_all, diploid = FALSE, digits = 2) 

# lista de formatos de hierfstat por especie
hfstat_list = lapply(gind_list, genind2hierfstat)
names(hfstat_list) = unique(df$Species)

basicstat_sp = lapply(hfstat_list, function(x) basic.stats(x,diploid = F,digits = 2))

# Hs per population
hs = Hs(hfstat)

# Riqueza alelica rarefacción
PopGenReport::allel.rich(genind, min.alleles = NULL)


```


```{r}
library(mmod)

diff_stats_all <- diff_stats(genind)

diff_stats_sp = lapply(gind_list,diff_stats)

set.seed(20151219) # Be sure to set a seed for any random analysis!
reps <- chao_bootstrap(genind, nreps = 10)
summarise_bootstrap(reps, Gst) 

```

## Estructura genética 


```{r}

library("poppr")
res <- poppr.amova(genind, ~  Species/pop, within = FALSE)
set.seed(98750)
randtest(res, nrepet = 999)

```


## Red de haplotipos


```{r}
library(poppr)
dist = bitwise.dist(genind)
setPop(genind) <- ~Species
net = bruvo.msn(genind)

data(nancycats)

bruvo.msn(genind, replen = rep(2, 51), vertex.label="inds", 
               vertex.label.cex=0.7, vertex.label.dist=0.4)

poppr.msn(genind, dist, gadj = 15, vertex.label = NA)
```


```{r}
library(pegas)
library(ggraph)


loc = as.loci(genind)

h = pegas::haplotype(loc, locus = 1:8)

dist = dist.haplotype.loci(h)

nt = rmst(dist)

igraph = as.igraph.haploNet(nt)


plot(nt, threshold = c(1,10), size = attr(nt, "weight"), fast = TRUE)

```



```{r}
ind = as.data.frame(loc)
ind$hap = 0

list = as.data.frame(h[1:8,1:110])

i = 1
for(i in 1:ncol(list)){

    t = apply(ind[,-c(1,10)],1,function(x) {all(x == list[,i])})
    ind$hap[which(t)] = i
}

strata = df[,c(1,3)] %>% mutate(pop = str_remove(df$pop,"pop")) %>% distinct()

freq = ind[,c(1,10)] %>% 
        left_join(strata,by = c("population" = "pop")) %>% 
        select(-population) %>%
        group_by(hap,Species) %>% 
        mutate(Freq = n()) %>% distinct() %>%  ungroup %>%
        pivot_wider(id_cols = c(hap), names_from = Species, values_from = Freq, values_fill = 0) %>% 
        mutate(`Quercus hypoleucoides` = `Quercus hypoleucoides`/sum(`Quercus hypoleucoides`,`Quercus scytophylla`,`Quercus sideroxyla`),
                `Quercus scytophylla` = `Quercus scytophylla`/sum(`Quercus hypoleucoides`,`Quercus scytophylla`,`Quercus sideroxyla`),
                `Quercus sideroxyla` = `Quercus sideroxyla`/sum(`Quercus hypoleucoides`,`Quercus scytophylla`,`Quercus sideroxyla`),
                hap = as.character(hap)) 

```


```{r}
igraph = igraph %>% igraph::as_data_frame(., 'both') 

igraph[[1]] = igraph[[1]] %>% left_join(freq,by = c("name" = "hap"))

graph_from_data_frame(igraph$edges,directed = F,vertices = igraph$vertices) %>% ggraph(.) + 
  geom_edge_link() + 
  geom_node_point(aes(color = `Quercus hypoleucoides` > 0)) +
  geom_node_text(aes(label = name), repel=TRUE)+
  theme_graph()


f$data %>% left_join(distinct(),by = c("name" = "hap"))
data = freq, aes(color = Species, size = Freq)
```